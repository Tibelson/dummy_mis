<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Portal - MIS Web</title>
  <link href="./dist/output.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="styles.css" rel="stylesheet">
  <link href="global-fixes.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-lg border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
      <a href="home.html" class="text-gray-700 hover:text-blue-600 font-semibold">Home</a>
      <div class="space-x-4">
        <a href="#" class="nav-link" onclick="showSection('dashboard')">Dashboard</a>
        <a href="#" class="nav-link" onclick="showSection('courses')">Courses</a>
        <a href="#" class="nav-link" onclick="showSection('students')">Students</a>
        <a href="#" class="nav-link" onclick="showSection('lecturers')">Lecturers</a>
        <a href="#" class="nav-link" onclick="showSection('enrollments')">Enrollments</a>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <section id="dashboard" class="section">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">Admin Dashboard</h1>
      <div class="grid grid-cols-4 gap-6 mb-8">
        <div class="card"><p class="card-title">Total Students</p><p id="statStudents" class="text-2xl font-bold">-</p></div>
        <div class="card"><p class="card-title">Total Courses</p><p id="statCourses" class="text-2xl font-bold">-</p></div>
        <div class="card"><p class="card-title">Lecturers</p><p id="statLecturers" class="text-2xl font-bold">-</p></div>
        <div class="card"><p class="card-title">Enrollments</p><p id="statEnrollments" class="text-2xl font-bold">-</p></div>
      </div>
    </section>

    <section id="courses" class="section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Manage Courses</h2>
         <button class="btn-primary" onclick="openAddCourse()"><i class="fas fa-plus mr-2"></i><span>Add Course</span></button>
      </div>
      <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <section id="students" class="section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Manage Students</h2>
         <button class="btn-primary" onclick="openAddStudent()"><i class="fas fa-plus mr-2"></i><span>Add Student</span></button>
      </div>
      <div id="studentsList" class="space-y-3"></div>
    </section>

    <section id="lecturers" class="section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Manage Lecturers</h2>
         <button class="btn-primary" onclick="openAddLecturer()"><i class="fas fa-plus mr-2"></i><span>Add Lecturer</span></button>
      </div>
      <div id="lecturersList" class="space-y-3"></div>
    </section>

    <section id="enrollments" class="section hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Manage Enrollments</h2>
         <button class="btn-primary" onclick="openAddEnrollment()"><i class="fas fa-plus mr-2"></i><span>Add Enrollment</span></button>
      </div>
      <div id="enrollmentsList" class="space-y-3"></div>
    </section>
  </main>

  <!-- Add Course Modal -->
  <div id="addCourseModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Course</h3>
        <button onclick="closeModal('addCourseModal')" class="modal-close">&times;</button>
      </div>
      <form id="addCourseForm" onsubmit="handleAddCourse(event)">
        <div class="form-group">
          <label>Course Code</label>
          <input type="text" id="courseCode" required class="form-input">
        </div>
        <div class="form-group">
          <label>Course Title</label>
          <input type="text" id="courseTitle" required class="form-input">
        </div>
        <div class="form-group">
          <label>Credits</label>
          <input type="number" id="courseCredits" required class="form-input" min="1" max="6">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="courseDescription" class="form-input" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Semester</label>
          <select id="courseSemester" required class="form-input">
            <option value="">Select Semester</option>
            <option value="Fall 2024">Fall 2024</option>
            <option value="Spring 2025">Spring 2025</option>
            <option value="Summer 2025">Summer 2025</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="closeModal('addCourseModal')" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Add Course</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div id="addStudentModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Student</h3>
        <button onclick="closeModal('addStudentModal')" class="modal-close">&times;</button>
      </div>
      <form id="addStudentForm" onsubmit="handleAddStudent(event)">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="studentFirstName" required class="form-input">
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="studentLastName" required class="form-input">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="studentEmail" required class="form-input">
        </div>
        <div class="form-group">
          <label>Admission Number</label>
          <input type="text" id="studentAdmissionNumber" required class="form-input">
        </div>
        <div class="form-group">
          <label>Date of Birth</label>
          <input type="date" id="studentDateOfBirth" required class="form-input">
        </div>
        <div class="form-group">
          <label>Department</label>
          <input type="text" id="studentDepartment" required class="form-input">
        </div>
        <div class="modal-footer">
          <button type="button" onclick="closeModal('addStudentModal')" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Add Student</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Lecturer Modal -->
  <div id="addLecturerModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Lecturer</h3>
        <button onclick="closeModal('addLecturerModal')" class="modal-close">&times;</button>
      </div>
      <form id="addLecturerForm" onsubmit="handleAddLecturer(event)">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="lecturerFirstName" required class="form-input">
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="lecturerLastName" required class="form-input">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="lecturerEmail" required class="form-input">
        </div>
        <div class="form-group">
          <label>Employee Number</label>
          <input type="text" id="lecturerEmployeeNumber" required class="form-input">
        </div>
        <div class="form-group">
          <label>Department</label>
          <input type="text" id="lecturerDepartment" required class="form-input">
        </div>
        <div class="form-group">
          <label>Specialization</label>
          <input type="text" id="lecturerSpecialization" required class="form-input">
        </div>
        <div class="form-group">
          <label>Phone Number</label>
          <input type="tel" id="lecturerPhoneNumber" class="form-input">
        </div>
        <div class="form-group">
          <label>Hire Date</label>
          <input type="date" id="lecturerHireDate" required class="form-input">
        </div>
        <div class="modal-footer">
          <button type="button" onclick="closeModal('addLecturerModal')" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Add Lecturer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Enrollment Modal -->
  <div id="addEnrollmentModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Enrollment</h3>
        <button onclick="closeModal('addEnrollmentModal')" class="modal-close">&times;</button>
      </div>
      <form id="addEnrollmentForm" onsubmit="handleAddEnrollment(event)">
        <div class="form-group">
          <label>Student</label>
          <select id="enrollmentStudentId" required class="form-input">
            <option value="">Select Student</option>
          </select>
        </div>
        <div class="form-group">
          <label>Course</label>
          <select id="enrollmentCourseId" required class="form-input">
            <option value="">Select Course</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="button" onclick="closeModal('addEnrollmentModal')" class="btn-secondary">Cancel</button>
          <button type="submit" class="btn-primary">Add Enrollment</button>
        </div>
      </form>
    </div>
  </div>

              <script src="api.js"></script>
            <script>
                // Check authentication
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userRole = localStorage.getItem('userRole');
                
                if (!userRole || userRole !== 'ADMIN') {
                    alert('Access denied. Please login as an admin.');
                    window.location.href = 'login.html';
                }
                
                let state = { students: [], courses: [], lecturers: [] };

    function hideAll(){ 
        document.querySelectorAll('.section').forEach(s=>s?.classList?.add('hidden')); 
    }
    function showSection(id){ 
        hideAll(); 
        document.querySelectorAll('.nav-link').forEach(l=>l?.classList?.remove('active')); 
        const navLink = document.querySelector(`[onclick="showSection('${id}')"]`);
        if (navLink) navLink.classList.add('active');
        const section = document.getElementById(id);
        if (section) section.classList.remove('hidden');
    }

    function openModal(id){ 
        const modal = document.getElementById(id);
        if (modal) modal.classList.remove('hidden'); 
    }
    function closeModal(id){ 
        const modal = document.getElementById(id);
        if (modal) modal.classList.add('hidden'); 
    }

    async function init(){
      try {
        // Load dashboard stats
        const stats = await api.request('/admin/dashboard/stats');
        const statStudents = document.getElementById('statStudents');
        const statCourses = document.getElementById('statCourses');
        const statLecturers = document.getElementById('statLecturers');
        const statEnrollments = document.getElementById('statEnrollments');
        
        if (statStudents) statStudents.textContent = stats.totalStudents;
        if (statCourses) statCourses.textContent = stats.totalCourses;
        if (statLecturers) statLecturers.textContent = stats.totalLecturers;
        if (statEnrollments) statEnrollments.textContent = stats.totalEnrollments;

        // Load data
        const [students, courses, lecturers] = await Promise.all([
          api.getStudents().catch(()=>[]),
          api.getCourses().catch(()=>[]),
          api.getLecturers().catch(()=>[])
        ]);
        
        state.students = students;
        state.courses = courses;
        state.lecturers = lecturers;

        renderCourses();
        renderStudents();
        renderLecturers();
        renderEnrollments();
      } catch(err) {
        console.error(err);
        showNotification('Failed to initialize Admin page', 'error');
      }
    }

    function renderCourses(){
      const grid = document.getElementById('coursesGrid');
      grid.innerHTML = state.courses.map(c=>`<div class="bg-white rounded shadow p-5">
        <div class="font-semibold mb-1">${c.courseTitle}</div>
        <div class="text-sm text-gray-600 mb-3">${c.courseCode} • ${c.credits} credits</div>
        <div class="text-sm text-gray-500 mb-3">${c.description||'No description'}</div>
        <div class="flex gap-2">
          <button class="btn-primary" onclick="editCourse(${c.id})"><i class="fas fa-edit mr-1"></i><span>Edit</span></button>
          <button class="btn-secondary" onclick="deleteCourse(${c.id})"><i class="fas fa-trash mr-1"></i><span>Delete</span></button>
        </div>
      </div>`).join('');
    }

    function renderStudents(){
      const list = document.getElementById('studentsList');
      list.innerHTML = state.students.map(s=>`<div class="bg-white rounded shadow p-4 flex items-center justify-between">
        <div>
          <div class="font-medium">${s.firstName} ${s.lastName}</div>
          <div class="text-sm text-gray-600">${s.email} • ${s.admissionNumber}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn-primary" onclick="editStudent(${s.id})"><i class="fas fa-edit mr-1"></i><span>Edit</span></button>
          <button class="btn-secondary" onclick="deleteStudent(${s.id})"><i class="fas fa-trash mr-1"></i><span>Delete</span></button>
        </div>
      </div>`).join('');
    }

    function renderLecturers(){
      const list = document.getElementById('lecturersList');
      list.innerHTML = state.lecturers.map(l=>`<div class="bg-white rounded shadow p-4 flex items-center justify-between">
        <div>
          <div class="font-medium">${l.firstName} ${l.lastName}</div>
          <div class="text-sm text-gray-600">${l.email} • ${l.department||''}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn-primary" onclick="editLecturer(${l.id})"><i class="fas fa-edit mr-1"></i><span>Edit</span></button>
          <button class="btn-secondary" onclick="deleteLecturer(${l.id})"><i class="fas fa-trash mr-1"></i><span>Delete</span></button>
        </div>
      </div>`).join('');
    }

    function renderEnrollments(){
      // This would need a separate API call to get enrollments
      document.getElementById('enrollmentsList').innerHTML = '<p class="text-gray-500">Enrollment management coming soon...</p>';
    }

    // Modal functions
    function openAddCourse(){ openModal('addCourseModal'); }
    function openAddStudent(){ openModal('addStudentModal'); }
    function openAddLecturer(){ openModal('addLecturerModal'); }
    function openAddEnrollment(){ 
      // Populate dropdowns
      const studentSelect = document.getElementById('enrollmentStudentId');
      const courseSelect = document.getElementById('enrollmentCourseId');
      
      studentSelect.innerHTML = '<option value="">Select Student</option>' + 
        state.students.map(s=>`<option value="${s.id}">${s.firstName} ${s.lastName} (${s.admissionNumber})</option>`).join('');
      
      courseSelect.innerHTML = '<option value="">Select Course</option>' + 
        state.courses.map(c=>`<option value="${c.id}">${c.courseCode} - ${c.courseTitle}</option>`).join('');
      
      openModal('addEnrollmentModal'); 
    }

    // Form handlers
    async function handleAddCourse(event){
      event.preventDefault();
      const courseCode = document.getElementById('courseCode')?.value;
      const courseTitle = document.getElementById('courseTitle')?.value;
      const courseCredits = document.getElementById('courseCredits')?.value;
      const courseDescription = document.getElementById('courseDescription')?.value;
      const courseSemester = document.getElementById('courseSemester')?.value;
      
      if (!courseCode || !courseTitle || !courseCredits || !courseSemester) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      const data = {
        courseCode: courseCode,
        courseTitle: courseTitle,
        credits: parseInt(courseCredits),
        description: courseDescription || '',
        semester: courseSemester
      };
      
      try {
        await api.createCourse(data);
        closeModal('addCourseModal');
        const form = document.getElementById('addCourseForm');
        if (form) form.reset();
        init(); // Reload data
        showNotification('Course added successfully', 'success');
      } catch(err) {
        showNotification('Failed to add course: ' + err.message, 'error');
      }
    }

    async function handleAddStudent(event){
      event.preventDefault();
      const firstName = document.getElementById('studentFirstName')?.value;
      const lastName = document.getElementById('studentLastName')?.value;
      const email = document.getElementById('studentEmail')?.value;
      const admissionNumber = document.getElementById('studentAdmissionNumber')?.value;
      const dateOfBirth = document.getElementById('studentDateOfBirth')?.value;
      const department = document.getElementById('studentDepartment')?.value;
      
      if (!firstName || !lastName || !email || !admissionNumber || !dateOfBirth || !department) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      const data = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        admissionNumber: admissionNumber,
        dateOfBirth: dateOfBirth,
        department: department
      };
      
      try {
        await api.createStudent(data);
        closeModal('addStudentModal');
        const form = document.getElementById('addStudentForm');
        if (form) form.reset();
        init(); // Reload data
        showNotification('Student added successfully', 'success');
      } catch(err) {
        showNotification('Failed to add student: ' + err.message, 'error');
      }
    }

    async function handleAddLecturer(event){
      event.preventDefault();
      const firstName = document.getElementById('lecturerFirstName')?.value;
      const lastName = document.getElementById('lecturerLastName')?.value;
      const email = document.getElementById('lecturerEmail')?.value;
      const employeeNumber = document.getElementById('lecturerEmployeeNumber')?.value;
      const department = document.getElementById('lecturerDepartment')?.value;
      const specialization = document.getElementById('lecturerSpecialization')?.value;
      const phoneNumber = document.getElementById('lecturerPhoneNumber')?.value;
      const hireDate = document.getElementById('lecturerHireDate')?.value;
      
      if (!firstName || !lastName || !email || !employeeNumber || !department || !specialization || !phoneNumber || !hireDate) {
        showNotification('Please fill in all required fields', 'error');
        return;
      }
      
      const data = {
        firstName: firstName,
        lastName: lastName,
        email: email,
        employeeNumber: employeeNumber,
        department: department,
        specialization: specialization,
        phoneNumber: phoneNumber,
        hireDate: hireDate
      };
      
      try {
        await api.createLecturer(data);
        closeModal('addLecturerModal');
        const form = document.getElementById('addLecturerForm');
        if (form) form.reset();
        init(); // Reload data
        showNotification('Lecturer added successfully', 'success');
      } catch(err) {
        showNotification('Failed to add lecturer: ' + err.message, 'error');
      }
    }

    async function handleAddEnrollment(event){
      event.preventDefault();
      const studentId = document.getElementById('enrollmentStudentId')?.value;
      const courseId = document.getElementById('enrollmentCourseId')?.value;
      
      if (!studentId || !courseId) {
        showNotification('Please select both student and course', 'error');
        return;
      }
      
      try {
        await api.request('/admin/enrollments?studentId=' + studentId + '&courseId=' + courseId, { method: 'POST' });
        closeModal('addEnrollmentModal');
        const form = document.getElementById('addEnrollmentForm');
        if (form) form.reset();
        showNotification('Enrollment added successfully', 'success');
      } catch(err) {
        showNotification('Failed to add enrollment: ' + err.message, 'error');
      }
    }

    // Admin actions
    function editCourse(id){ showNotification('Edit course '+id+' - coming soon', 'info'); }
    async function deleteCourse(id){ 
        if(confirm('Delete course?')){ 
            try {
                await api.deleteCourse(id); 
                init();
                showNotification('Course deleted successfully', 'success');
            } catch(err) {
                showNotification('Failed to delete course: ' + err.message, 'error');
            }
        } 
    }

    function editStudent(id){ showNotification('Edit student '+id+' - coming soon', 'info'); }
    async function deleteStudent(id){ 
        if(confirm('Delete student?')){ 
            try {
                await api.deleteStudent(id); 
                init();
                showNotification('Student deleted successfully', 'success');
            } catch(err) {
                showNotification('Failed to delete student: ' + err.message, 'error');
            }
        } 
    }

    function editLecturer(id){ showNotification('Edit lecturer '+id+' - coming soon', 'info'); }
    async function deleteLecturer(id){ 
        if(confirm('Delete lecturer?')){ 
            try {
                await api.deleteLecturer(id); 
                init();
                showNotification('Lecturer deleted successfully', 'success');
            } catch(err) {
                showNotification('Failed to delete lecturer: ' + err.message, 'error');
            }
        } 
    }

    // Check if there's a specific section to show
    const adminSection = localStorage.getItem('adminSection');
    if (adminSection) {
        showSection(adminSection);
        localStorage.removeItem('adminSection'); // Clear after use
    }
    
    // Notification function
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-blue-500 text-white'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    'fa-info-circle'
                } mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    init();
  </script>
</body>
</html> 